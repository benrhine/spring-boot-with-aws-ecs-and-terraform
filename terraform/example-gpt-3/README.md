# Example GPT 3 (EC2)

This example was generated by ChatGPT and edited for the purposes of this tutorial. Example 3 could/should be considered
a production worthy example. It uses the more modern `aws_lb` resources.

This example is deployed to EC2 instances on ECS and uses `bridge` networking mode.

This continues to build on the gpt-1 and gpt-2 examples and swaps out the deprecated legacy load balancer for the more
modern `aws_lb` load balancer.

*WARNING!!! This example works find, but it DOES NOT clean up correctly and I do not understand why. No combination of 
`depends_on` has yielded any fruit and the suggestion of `force_delete = true` has not worked either. In order to get this
example to clean up correctly, you must first go into the AWS Console and navigate to EC2 -> scroll to the bottom of the page ->
select "Auto Scaling Groups" -> select the group -> delete. This must be done before telling terraform to destroy*

## Quickstart

### Deploy

* `terraform init`
    * With multiple examples in this repo this should be run every time you change examples
* `terraform validate`
* `terraform plan`
* `terraform apply -auto-approve`

### Test

The DNS name of the resources will be returned as an output for testing purposes

### Destroy / Cleanup

* `terraform destroy -auto-approve`

## Things that are the same across examples

* `provider.tf` is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3,
* `terraform.tf` is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3,
* `utils.tf` is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3,
* `data.tf` is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3,
* `ecs.tf` is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3,
* `iam.tf` is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3,

## Things that are similar

* `vpc.tf` has the exact same configuration as example-gpt-1, example-gpt-2, but for example-1 and example-gpt-3 includes an additional subnet and mapping
* `security-group.tf` has the same configuration in example-1, example-gpt-1, example-gpt-2 with an additional security group in example-gpt-3

## Things that are different 

* additional `aws_security_group` which applies another security group to its ingress
  * The "other" security group is exactly the same for example-1, example-gpt-1, example-gpt-2, example-gpt-3
* includes a more modern `aws_lb` (load balancer)
  * which requires a `aws_lb_target_group`, `aws_lb_listener`

## Reference for destroy problem 

* https://www.reddit.com/r/Terraform/comments/11q8q4n/auto_scaling_groups_removal/
* https://stackoverflow.com/questions/72231098/terraform-aws-auto-scaling-group-not-deleting-when-using-suspended-policy-opti
* https://stackoverflow.com/questions/66703697/aws-autoscaling-group-ec2-instance-create-before-destroy